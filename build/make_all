#!/bin/bash
set -ex

# Load variables
#
# Load all variables used in the build process.
for vars in variable*; do
   source $vars
done

# Execution
#
# Executing the script.

for entry in "versions"/*
do
    source $entry

    SOURCE_FROM=$(grep '\<FROM\>' ../Dockerfile)
    TARGET_FROM="FROM ${FROM}"
    sed -i "s/${SOURCE_FROM}/${TARGET_FROM}/g" ../Dockerfile

    docker build \
        --build-arg BUILD_DATE="${DATE}"\
        --build-arg VERSION="${VERSION}"\
        --build-arg S6_OVERLAY_VERSION="${S6_OVERLAY_VERSION}"\
        --build-arg S6_OVERLAY_URL="${S6_OVERLAY_URL}"\
        --pull -t ${IMAGE}:${TAG} ../.

    sed -i "s/${TARGET_FROM}/${SOURCE_FROM}/g" ../Dockerfile
done